name: Build and Test

on:
  push:
    branches: [ main, develop, fix/wondowsBuild ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          python3 \
          python3-pip \
          libgl1-mesa-dev \
          libx11-dev \
          libxrandr-dev \
          libxi-dev \
          libudev-dev \
          libasound2-dev

    - name: Install Conan
      run: |
        pip3 install conan
        conan profile detect --force

    - name: Install dependencies with Conan
      run: |
        conan install . --output-folder=build --build=missing --profile=conan_profile

    - name: Configure CMake
      run: |
        cmake --preset conan-release

    - name: Build project
      run: |
        cmake --build build --config Release

    - name: Check executables
      run: |
        ls -lh build/server/server
        ls -lh build/client/client
        file build/server/server
        file build/client/client

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-binaries
        path: |
          build/server/server
          build/client/client
        retention-days: 7

  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect --force

    - name: Verify Conan profile
      run: |
        conan profile show default

    - name: Install dependencies with Conan
      run: |
        conan install . --output-folder=build --build=missing

    - name: Configure CMake
      run: |
        cmake -S . -B build -G "Visual Studio 17 2022" -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake

    - name: Build project
      run: |
        cmake --build build --config Release

    - name: Check executables
      run: |
        dir build\server\Release\
        dir build\client\Release\
        if (Test-Path build\server\Release\server.exe) { Write-Host "✓ Server built successfully" } else { exit 1 }
        if (Test-Path build\client\Release\client.exe) { Write-Host "✓ Client built successfully" } else { exit 1 }

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-binaries
        path: |
          build/server/Release/server.exe
          build/client/Release/client.exe
        retention-days: 7

  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    if: always()
    
    steps:
    - name: Check build results
      run: |
        if [[ "${{ needs.build-linux.result }}" == "success" && "${{ needs.build-windows.result }}" == "success" ]]; then
          echo "✅ All builds successful!"
          exit 0
        else
          echo "❌ Some builds failed:"
          echo "  Linux: ${{ needs.build-linux.result }}"
          echo "  Windows: ${{ needs.build-windows.result }}"
          exit 1
        fi
