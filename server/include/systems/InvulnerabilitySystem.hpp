/*
** EPITECH PROJECT, 2025
** R-type
** File description:
** InvulnerabilitySystem.hpp - Decrease invulnerability timers and remove component when expired
*/

#ifndef SERVER_INVULNERABILITY_SYSTEM_HPP_
#define SERVER_INVULNERABILITY_SYSTEM_HPP_

#include "../../../engineCore/include/ecs/ISystem.hpp"
#include "../../../engineCore/include/ecs/World.hpp"
#include "../../../engineCore/include/ecs/components/Invulnerable.hpp"
#include "ecs/ComponentSignature.hpp"
#include <vector>

namespace server
{

class InvulnerabilitySystem : public ecs::ISystem
{
public:
  InvulnerabilitySystem() = default;

  void update(ecs::World &world, float deltaTime) override
  {
    std::vector<ecs::Entity> entities;
    ecs::ComponentSignature sig;
    sig.set(ecs::getComponentId<ecs::Invulnerable>());
    world.getEntitiesWithSignature(sig, entities);

    for (auto entity : entities) {
      if (!world.isAlive(entity))
        continue;
      auto &inv = world.getComponent<ecs::Invulnerable>(entity);
      inv.remaining -= deltaTime;
      if (inv.remaining <= 0.0F) {
        world.removeComponent<ecs::Invulnerable>(entity);
      }
    }
  }

  [[nodiscard]] ecs::ComponentSignature getSignature() const override
  {
    ecs::ComponentSignature sig;
    sig.set(ecs::getComponentId<ecs::Invulnerable>());
    return sig;
  }
};

} // namespace server

#endif // SERVER_INVULNERABILITY_SYSTEM_HPP_
